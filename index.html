<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch√†o nƒÉm m·ªõi OS2-DX V≈©ng t√†u 2026 (Ti·∫øt Ki·ªám)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js for Markdown rendering in chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Custom Palette & Styles -->
    <style>
        :root {
            /* Palette: Tropical Vibrance */
            --color-bg: #F0F9FF; /* Light Sky Blue */
            --color-card: #FFFFFF;
            --color-primary: #0284C7; /* Ocean Blue */
            --color-secondary: #F59E0B; /* Sun Amber */
            --color-accent: #EF4444; /* Coral Red */
            --color-text: #1E293B; /* Slate 800 */
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background-color: #CBD5E1;
            z-index: 0;
        }
        
        .timeline-item {
            position: relative;
            z-index: 10;
        }

        /* Utilities */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* AI Chat Widget Styles */
        .ai-widget-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .ai-widget-btn:hover {
            transform: scale(1.1);
        }

        .ai-chat-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 90%;
            max-width: 400px;
            height: 500px;
            z-index: 49;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .ai-chat-window.hidden-chat {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            pointer-events: none;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user {
            background-color: #0284C7;
            color: white;
            align-self: flex-end;
            margin-left: 2rem;
        }

        .chat-message.ai {
            background-color: #F3F4F6;
            color: #1F2937;
            align-self: flex-start;
            margin-right: 2rem;
            border-left: 3px solid #F59E0B;
        }

        .chat-message.ai p {
            margin-bottom: 0.5rem;
        }
        .chat-message.ai ul {
            list-style-type: disc;
            margin-left: 1.2rem;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 1px;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Free Time Highlight */
        .free-time-badge {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
    <!-- 
    PALETTE SELECTION: "Tropical Vibrance" 
    Primary: #0284C7 (Ocean Blue)
    Secondary: #F59E0B (Sun/Sand)
    Accent: #EF4444 (Coral Red)
    
    UPDATES:
    - Reduced budget per person to 600~700k.
    - Updated charts: Food reduced to 1.8M total, Backup reduced to 300k total.
    - Added "Free Time" slots in itinerary.
    - Updated AI prompt with new budget context.
    
    NO SVG USED. NO MERMAID USED.
    -->
</head>
<body class="antialiased selection:bg-yellow-200 selection:text-blue-900">

    <!-- HERO SECTION -->
    <header class="w-full bg-gradient-to-r from-emerald-600 to-teal-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-12 text-center">
            <div class="inline-block bg-yellow-400 text-blue-900 font-bold px-3 py-1 rounded-full text-sm mb-4">
                02/01/2026 - 03/01/2026
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold mb-4 tracking-tight uppercase leading-tight">
                Ch√†o nƒÉm m·ªõi<br class="md:hidden"> OS2-DX V≈©ng T√†u 2026
            </h1>
            <p class="text-xl md:text-2xl font-light opacity-90 mb-2">
                ƒê√≥n nƒÉm m·ªõi c√πng nheo
            </p>
            
            <!-- Team Members List -->
            <div class="inline-block bg-white/10 backdrop-blur-md rounded-xl p-4 mb-6 border border-white/20">
                <span class="block text-xs uppercase tracking-wider text-emerald-200 mb-1">Bi·ªát ƒê·ªôi OS2-DX</span>
                <p class="text-sm md:text-lg font-bold text-white">
                    nguyn_don_wut ‚Ä¢ √ân (b√© Na) ‚Ä¢ duyhung ‚Ä¢ h·ªØu khen
                </p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto mt-4">
                <div class="bg-white/20 backdrop-blur rounded-lg p-3">
                    <div class="text-2xl">üë•</div>
                    <div class="font-bold">4 Th√†nh vi√™n</div>
                </div>
                <div class="bg-white/20 backdrop-blur rounded-lg p-3">
                    <div class="text-2xl">üõµ</div>
                    <div class="font-bold">Xe m√°y</div>
                </div>
                <div class="bg-white/20 backdrop-blur rounded-lg p-3 border-2 border-yellow-400 text-yellow-300">
                    <div class="text-2xl">üí∞</div>
                    <div class="font-bold">6~700k/Ng∆∞·ªùi</div>
                </div>
                <div class="bg-white/20 backdrop-blur rounded-lg p-3">
                    <div class="text-2xl">üåä</div>
                    <div class="font-bold">2 Ng√†y 1 ƒê√™m</div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 space-y-16 pb-32">

        <!-- SECTION 1: PREPARATION -->
        <section id="preparation">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-teal-800 mb-6 flex items-center gap-3 border-b-4 border-yellow-400 pb-2 inline-block">
                    <span>üõ†Ô∏è</span> C√¥ng T√°c Chu·∫©n B·ªã
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1 -->
                    <div class="glass-card shadow-lg rounded-xl p-6 border-t-4 border-teal-500">
                        <div class="text-4xl mb-4 text-center">üèçÔ∏è</div>
                        <h3 class="text-xl font-bold text-center mb-3 text-teal-700">Ki·ªÉm Tra Xe</h3>
                        <p class="text-sm text-gray-600 text-center">ƒê·ªÉ ti·∫øt ki·ªám chi ph√≠ s·ª≠a xe d·ªçc ƒë∆∞·ªùng, h√£y b·∫£o d∆∞·ª°ng k·ªπ tr∆∞·ªõc khi ƒëi.</p>
                    </div>

                    <!-- Card 2 -->
                    <div class="glass-card shadow-lg rounded-xl p-6 border-t-4 border-yellow-500">
                        <div class="text-4xl mb-4 text-center">üè®</div>
                        <h3 class="text-xl font-bold text-center mb-3 text-yellow-600">Homestay Gi√° R·∫ª</h3>
                        <p class="text-sm text-gray-600 text-center">M·ª•c ti√™u: T√¨m ph√≤ng ~500k-600k/ƒë√™m cho 4 ng∆∞·ªùi. Xa B√£i Sau m·ªôt ch√∫t c≈©ng ƒë∆∞·ª£c.</p>
                    </div>

                    <!-- Card 3 -->
                    <div class="glass-card shadow-lg rounded-xl p-6 border-t-4 border-red-500">
                        <div class="text-4xl mb-4 text-center">üéí</div>
                        <h3 class="text-xl font-bold text-center mb-3 text-red-600">ƒê·ªì C√° Nh√¢n</h3>
                        <p class="text-sm text-gray-600 text-center">Mang theo n∆∞·ªõc su·ªëi v√† ƒë·ªì ƒÉn v·∫∑t t·ª´ nh√† ƒë·ªÉ ti·∫øt ki·ªám ti·ªÅn mua d·ªçc ƒë∆∞·ªùng.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: BUDGET ANALYSIS -->
        <section id="budget" class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-teal-800 mb-6 flex items-center gap-3 border-b-4 border-yellow-400 pb-2 inline-block">
                <span>üí∏</span> Ph√¢n T√≠ch T√†i Ch√≠nh (M·ªõi)
            </h2>
            <p class="text-gray-600 mb-8 text-lg">
                ƒê√£ ƒëi·ªÅu ch·ªânh ng√¢n s√°ch xu·ªëng <strong>3.200.000 VNƒê (600~700K/ng∆∞·ªùi)</strong>. 
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-bold">Ti·∫øt ki·ªám ƒë∆∞·ª£c 600~700K cho c·∫£ nh√≥m!</span>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                <!-- Chart 1: Donut Distribution -->
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">C∆° C·∫•u Chi Ti√™u (T·ªïng 3.2 Tri·ªáu)</h3>
                    <div class="chart-container">
                        <canvas id="budgetDonutChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Detailed Bar -->
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Chi Ti·∫øt H·∫°ng M·ª•c (VNƒê)</h3>
                    <div class="chart-container">
                        <canvas id="budgetBarChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-500 mt-4 text-center italic max-w-xs">
                        *ƒÇn u·ªëng: Gi·∫£m c√≤n 450k/ng∆∞·ªùi (ƒÇn ngon nh∆∞ng qu√°n b√¨nh d√¢n).
                        *D·ª± ph√≤ng: Gi·∫£m c√≤n 300k (ƒêi c·∫©n th·∫≠n l√† ƒë·ªß).
                    </p>
                </div>
            </div>
        </section>

        <!-- SECTION 3: ITINERARY DAY 1 -->
        <section id="day1">
            <h2 class="text-3xl font-bold text-teal-800 mb-6 flex items-center gap-3 border-b-4 border-yellow-400 pb-2 inline-block">
                <span>üìÖ</span> Ng√†y 1: S√†i G√≤n - Bi·ªÉn & T·ª± Do
            </h2>
            <div class="relative max-w-3xl mx-auto">
                <div class="hidden md:block timeline-line bg-teal-200"></div>

                <!-- Item 1 -->
                <div class="timeline-item flex flex-col md:flex-row items-center justify-between mb-8 w-full">
                    <div class="order-1 w-full md:w-5/12"></div>
                    <div class="z-20 flex items-center order-1 bg-teal-500 shadow-xl w-12 h-12 rounded-full justify-center text-white font-bold text-sm">05:30</div>
                    <div class="order-1 w-full md:w-5/12 px-6 py-4 bg-white rounded-lg shadow-md border-l-4 border-teal-500 mt-4 md:mt-0">
                        <h3 class="font-bold text-teal-800 text-lg">Xu·∫•t Ph√°t</h3>
                        <p class="text-sm text-gray-600">Ph√† C√°t L√°i -> Nh∆°n Tr·∫°ch. ƒêi s·ªõm cho m√°t.</p>
                    </div>
                </div>

                <!-- Item 2 -->
                <div class="timeline-item flex flex-col md:flex-row items-center justify-between mb-8 w-full">
                    <div class="order-1 w-full md:w-5/12 px-6 py-4 bg-white rounded-lg shadow-md border-r-4 border-yellow-500 mt-4 md:mt-0 md:text-right">
                        <h3 class="font-bold text-yellow-700 text-lg">ƒÇn S√°ng Nh·∫π Nh√†ng</h3>
                        <p class="text-sm text-gray-600">B√°nh m√¨ ho·∫∑c x√¥i d·ªçc ƒë∆∞·ªùng (~20k-30k) ƒë·ªÉ ti·∫øt ki·ªám h∆°n l√† v√†o qu√°n ph·ªü l·ªõn.</p>
                    </div>
                    <div class="z-20 flex items-center order-1 bg-yellow-500 shadow-xl w-12 h-12 rounded-full justify-center text-white font-bold text-sm">07:00</div>
                    <div class="order-1 w-full md:w-5/12"></div>
                </div>

                <!-- Item 3: Free Time Inserted -->
                <div class="timeline-item flex flex-col md:flex-row items-center justify-between mb-8 w-full">
                    <div class="order-1 w-full md:w-5/12"></div>
                    <div class="z-20 flex items-center order-1 bg-purple-500 shadow-xl w-12 h-12 rounded-full justify-center text-white font-bold text-sm">13:00</div>
                    <div class="order-1 w-full md:w-5/12 px-6 py-4 bg-white rounded-lg shadow-md border-l-4 border-purple-500 mt-4 md:mt-0">
                        <h3 class="font-bold text-purple-800 text-lg flex items-center">
                            Check-in & T·ª± Do <span class="free-time-badge">Free Time</span>
                        </h3>
                        <p class="text-sm text-gray-600">Nh·∫≠n ph√≤ng ngh·ªâ ng∆°i. Sau ƒë√≥ <strong>t·ª´ 13:30 ƒë·∫øn 15:30 l√† th·ªùi gian t·ª± do</strong>. C√≥ th·ªÉ l∆∞·ª£n l·ªù c√°c con h·∫ªm nh·ªè, t√¨m qu√°n cafe c√≥c, ho·∫∑c ng·ªß n∆∞·ªõng l·∫•y s·ª©c.</p>
                    </div>
                </div>

                <!-- Item 4 -->
                <div class="timeline-item flex flex-col md:flex-row items-center justify-between mb-8 w-full">
                    <div class="order-1 w-full md:w-5/12 px-6 py-4 bg-white rounded-lg shadow-md border-r-4 border-teal-500 mt-4 md:mt-0 md:text-right">
                        <h3 class="font-bold text-teal-800 text-lg">T·∫Øm Bi·ªÉn & Ho√†ng H√¥n</h3>
                        <p class="text-sm text-gray-600">B√£i Sau (Free). Ch·ª•p h√¨nh s·ªëng ·∫£o ·ªü M≈©i Nghinh Phong (Free).</p>
                    </div>
                    <div class="z-20 flex items-center order-1 bg-teal-500 shadow-xl w-12 h-12 rounded-full justify-center text-white font-bold text-sm">16:00</div>
                    <div class="order-1 w-full md:w-5/12"></div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: ITINERARY DAY 2 -->
        <section id="day2">
            <h2 class="text-3xl font-bold text-teal-800 mb-6 flex items-center gap-3 border-b-4 border-yellow-400 pb-2 inline-block">
                <span>‚òÄÔ∏è</span> Ng√†y 2: Ng·∫´u H·ª©ng & Tr·ªü V·ªÅ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Morning Block with Free Time -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-purple-400">
                    <div class="bg-purple-50 p-4 border-b border-purple-100">
                        <span class="font-bold text-purple-800">07:00 - 10:00</span>
                        <span class="free-time-badge float-right">Free Time</span>
                    </div>
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">S√°ng T·ª± Do</h3>
                        <p class="text-gray-600 text-sm">ƒÇn s√°ng t·ª± t√∫c (B√°nh m√¨ ch·∫£o/B√∫n ri√™u). Th·ªùi gian n√†y <strong>team c√≥ th·ªÉ ƒëi b·∫•t c·ª© ƒë√¢u ch∆∞a k·ªãp ƒëi h√¥m qua</strong> (H·ªì M√¢y, B·∫£o T√†ng, ho·∫∑c ƒë∆°n gi·∫£n l√† ch·∫°y xe v√≤ng quanh ƒë∆∞·ªùng ven bi·ªÉn).</p>
                    </div>
                </div>

                <!-- Sightseeing Block -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-teal-400">
                    <div class="bg-teal-50 p-4 border-b border-teal-100">
                        <span class="font-bold text-teal-800">10:00 - 11:30</span>
                    </div>
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">ƒê·ªìi Con Heo</h3>
                        <p class="text-gray-600 text-sm">ƒê·ªãa ƒëi·ªÉm check-in mi·ªÖn ph√≠, view ƒë·∫πp. Tranh th·ªß gh√© tr∆∞·ªõc khi tr·∫£ ph√≤ng.</p>
                    </div>
                </div>

                <!-- Lunch Block -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-red-400">
                    <div class="bg-red-50 p-4 border-b border-red-100">
                        <span class="font-bold text-red-800">12:00 - 13:30</span>
                    </div>
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">L·∫©u C√° ƒêu·ªëi</h3>
                        <p class="text-gray-600 text-sm">V·∫´n gi·ªØ m√≥n n√†y v√¨ l√† ƒë·∫∑c s·∫£n, nh∆∞ng g·ªçi n·ªìi v·ª´a ph·∫£i, ƒÉn k√®m rau b√∫n cho no (~120k/ng∆∞·ªùi).</p>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm pb-8">
            <p>¬© 2026 K·∫ø Ho·∫°ch V≈©ng T√†u - OS2-DX Team</p>
        </footer>

    </main>

    <!-- AI ASSISTANT UI -->
    <button id="aiToggleBtn" class="ai-widget-btn bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white rounded-full p-4 shadow-xl flex items-center gap-2 group">
        <span class="text-2xl">‚ú®</span>
        <span class="font-bold hidden group-hover:block transition-all duration-300">H·ªèi Th·ªï ƒê·ªãa</span>
    </button>

    <div id="aiChatWindow" class="ai-chat-window hidden-chat bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-teal-600 to-emerald-600 p-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <span class="text-xl">ü§ñ</span>
                <div>
                    <h3 class="font-bold">Th·ªï ƒê·ªãa Ti·∫øt Ki·ªám</h3>
                    <p class="text-xs text-teal-100 opacity-80">OS2-DX Budget Guide</p>
                </div>
            </div>
            <button id="closeChatBtn" class="hover:bg-white/20 rounded-full p-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Chat History -->
        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 bg-gray-50">
            <div class="chat-message ai">
                <p>Ch√†o nh√≥m OS2-DX! Ng√¢n s√°ch ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u xu·ªëng <strong>600~700K/ng∆∞·ªùi</strong>. Trong kho·∫£ng th·ªùi gian "Free Time", n·∫øu ch∆∞a bi·∫øt ƒëi ƒë√¢u cho ti·∫øt ki·ªám th√¨ c·ª© h·ªèi m√¨nh nh√©! üí∞</p>
            </div>
        </div>

        <!-- Quick Prompts -->
        <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="sendQuickPrompt('G·ª£i √Ω ch·ªó ƒÉn s√°ng d∆∞·ªõi 30k')" class="inline-block px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs hover:bg-teal-50 mr-2">ü•™ ƒÇn s√°ng r·∫ª</button>
            <button onclick="sendQuickPrompt('ƒê·ªãa ƒëi·ªÉm check-in mi·ªÖn ph√≠ ƒë·∫πp')" class="inline-block px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs hover:bg-teal-50 mr-2">üì∏ Check-in Free</button>
            <button onclick="sendQuickPrompt('Mua h·∫£i s·∫£n ·ªü ƒë√¢u r·∫ª nh·∫•t?')" class="inline-block px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs hover:bg-teal-50">ü¶Ä H·∫£i s·∫£n r·∫ª</button>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="flex items-center gap-2">
                <input type="text" id="userQueryInput" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                <button id="sendBtn" class="bg-teal-600 text-white rounded-full p-2 hover:bg-teal-700 transition-colors disabled:opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPT SECTION -->
    <script>
        // --- 1. Label Wrapping Helper Function (16 char limit) ---
        function wrapLabel(str, maxLen = 16) {
            if (str.length <= maxLen) return str;
            
            const words = str.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length <= maxLen) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // --- 2. Chart.js Global Config for Tooltips ---
        const tooltipConfig = {
            callbacks: {
                title: function(tooltipItems) {
                    const item = tooltipItems[0];
                    let label = item.chart.data.labels[item.dataIndex];
                    if (Array.isArray(label)) {
                        return label.join(' ');
                    } else {
                        return label;
                    }
                }
            }
        };

        // --- 3. Budget Donut Chart (UPDATED) ---
        const donutCtx = document.getElementById('budgetDonutChart').getContext('2d');
        const budgetLabels = ["ƒÇn u·ªëng", "Ch·ªó ·ªü", "D·ª± ph√≤ng", "XƒÉng xe", "V√© tham quan"];
        const wrappedBudgetLabels = budgetLabels.map(l => wrapLabel(l));

        // New total: 3.2M. Food: 1.8M, Backup: 300k
        new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels: wrappedBudgetLabels,
                datasets: [{
                    data: [1800000, 600000, 300000, 300000, 200000],
                    backgroundColor: [
                        '#EF4444', // Red - Eating
                        '#F59E0B', // Orange - Hotel
                        '#10B981', // Green - Backup
                        '#3B82F6', // Blue - Gas
                        '#8B5CF6'  // Purple - Tickets
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: { size: 12 }
                        }
                    },
                    tooltip: tooltipConfig,
                    title: {
                        display: true,
                        text: 'Ng√¢n S√°ch M·ªõi: 3.2 Tri·ªáu (600~700K/ng∆∞·ªùi)',
                        font: { size: 16 }
                    }
                }
            }
        });

        // --- 4. Budget Bar Chart (UPDATED) ---
        const barCtx = document.getElementById('budgetBarChart').getContext('2d');
        
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: wrappedBudgetLabels,
                datasets: [{
                    label: 'Chi ph√≠ (VNƒê)',
                    data: [1800000, 600000, 300000, 300000, 200000],
                    backgroundColor: '#0d9488', // Teal
                    borderRadius: 6,
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bar for better label reading
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: tooltipConfig,
                    title: {
                        display: true,
                        text: 'Chi Ti·∫øt H·∫°ng M·ª•c (ƒê√£ C·∫Øt Gi·∫£m)',
                        font: { size: 16 }
                    }
                }
            }
        });

        // --- 5. AI Assistant Logic ---
        const aiToggleBtn = document.getElementById('aiToggleBtn');
        const aiChatWindow = document.getElementById('aiChatWindow');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const chatHistory = document.getElementById('chatHistory');
        const userQueryInput = document.getElementById('userQueryInput');
        const sendBtn = document.getElementById('sendBtn');

        // Toggle Chat Window
        function toggleChat() {
            aiChatWindow.classList.toggle('hidden-chat');
        }

        aiToggleBtn.addEventListener('click', toggleChat);
        closeChatBtn.addEventListener('click', toggleChat);

        // Gemini API Configuration
        const apiKey = ""; // API Key provided by environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const systemPrompt = `
            B·∫°n l√† m·ªôt h∆∞·ªõng d·∫´n vi√™n du l·ªãch ƒë·ªãa ph∆∞∆°ng t·∫°i V≈©ng T√†u (Th·ªï ƒë·ªãa V≈©ng T√†u).
            
            NG·ªÆ C·∫¢NH ƒê·∫∂C BI·ªÜT C·ª¶A NH√ìM OS2-DX:
            - Th√†nh vi√™n: nguyn_don_wut, √ân (b√© Na), duyhung, h·ªØu khen...
            - Th·ªùi gian: 2 ng√†y 1 ƒë√™m (02/01/2026 - 03/01/2026).
            - Ph∆∞∆°ng ti·ªán: Xe m√°y.
            - **NG√ÇN S√ÅCH M·ªöI: 800.000 VNƒê/ng∆∞·ªùi** (ƒê√£ c·∫Øt gi·∫£m, c·∫ßn c·ª±c k·ª≥ ti·∫øt ki·ªám).
            - **Y√äU C·∫¶U M·ªöI:** C√≥ c√°c khung gi·ªù "Free Time" trong l·ªãch tr√¨nh ƒë·ªÉ ƒëi t·ª± do.

            NHI·ªÜM V·ª§ C·ª¶A B·∫†N:
            - G·ª£i √Ω c√°c qu√°n ƒÉn ngon - b·ªï - r·∫ª th·ª±c s·ª± (∆∞u ti√™n qu√°n v·ªâa h√®, d√¢n ƒë·ªãa ph∆∞∆°ng ƒÉn, gi√° d∆∞·ªõi 50k-100k).
            - G·ª£i √Ω c√°c ƒë·ªãa ƒëi·ªÉm tham quan MI·ªÑN PH√ç cho c√°c khung gi·ªù Free Time.
            - Khi nh·∫Øc ƒë·∫øn ng√¢n s√°ch, h√£y nh·∫Øc nh·ªü vui v·∫ª v·ªÅ vi·ªác "ti·∫øt ki·ªám ƒë·ªÉ c∆∞·ªõi v·ª£" ho·∫∑c t∆∞∆°ng t·ª±.
            - Lu√¥n nh·∫Øc t√™n nh√≥m OS2-DX.
            - ƒê·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi b·∫±ng Markdown.
        `;

        async function callGemini(userText) {
            appendMessage('user', userText);
            const typingId = appendTypingIndicator();

            try {
                const payload = {
                    contents: [{
                        parts: [{
                            text: systemPrompt + "\n\nUser Question: " + userText
                        }]
                    }]
                };

                let retries = 0;
                const maxRetries = 3;
                let result = null;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        result = await response.json();
                        break; 
                    } catch (e) {
                        retries++;
                        if (retries === maxRetries) throw e;
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries))); 
                    }
                }

                removeMessage(typingId);
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Xin l·ªói, m·∫°ng h∆°i lag. H·ªèi l·∫°i gi√∫p m√¨nh nha!";
                appendMessage('ai', aiText);

            } catch (error) {
                removeMessage(typingId);
                console.error("Gemini API Error:", error);
                appendMessage('ai', "Oops! C√≥ l·ªói x·∫£y ra. Th·ª≠ l·∫°i sau nh√©.");
            }
        }

        // UI Helper Functions for Chat
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `chat-message ${role}`;
            if (role === 'ai') {
                div.innerHTML = marked.parse(text);
            } else {
                div.textContent = text;
            }
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div.id; 
        }

        function appendTypingIndicator() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-message ai typing-indicator';
            div.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function sendQuickPrompt(text) {
            callGemini(text);
        }

        // Event Listeners for Input
        sendBtn.addEventListener('click', () => {
            const text = userQueryInput.value.trim();
            if (text) {
                callGemini(text);
                userQueryInput.value = '';
            }
        });

        userQueryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = userQueryInput.value.trim();
                if (text) {
                    callGemini(text);
                    userQueryInput.value = '';
                }
            }
        });
    </script>
</body>
</html>
